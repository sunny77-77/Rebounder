<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rebounder é€†è½‰è‚¡ç¥¨ - AI è¨ºæ–·ç³»çµ±</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- PropTypes -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.12.3/umd/Recharts.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Tooltip Animations */
        .tooltip-content {
            transition: opacity 0.2s, transform 0.2s;
            transform: translateY(4px);
            visibility: hidden;
            opacity: 0;
        }
        .group\/info:hover .tooltip-content,
        .group\/marker:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile optimizations for charts */
        .recharts-wrapper {
            max-width: 100%;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 text-sm antialiased">
    <div id="root"></div>

    <script type="text/babel">
        // Ensure libraries are loaded
        if (typeof React === 'undefined' || typeof ReactDOM === 'undefined' || typeof Recharts === 'undefined') {
            document.getElementById('root').innerHTML = '<div style="padding:20px;text-align:center;color:red">Libraries failed to load. Please check your internet connection.</div>';
            throw new Error("Libraries not loaded");
        }

        const { useState, useMemo, useEffect } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine, AreaChart, Area } = Recharts;

        // --- 1. Icons ---
        const IconBase = ({ children, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const ArrowLeft = (props) => <IconBase {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconBase>;
        const Activity = (props) => <IconBase {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase>;
        const Microscope = (props) => <IconBase {...props}><path d="M6 18h8"/><path d="M3 22h18"/><path d="M14 22a7 7 0 1 0 0-14h-1"/><path d="M9 14h2"/><path d="M9 12a2 2 0 0 1-2-2V6h6v4a2 2 0 0 1-2 2Z"/><path d="M12 6V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></IconBase>;
        const XCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></IconBase>;
        const Calendar = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const Target = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconBase>;
        const Lightbulb = (props) => <IconBase {...props}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.4 1.5-3.8 0-3.2-2.6-5.8-5.8-5.8-3.2 0-5.8 2.6-5.8 5.8 0 1.4.5 2.8 1.5 3.8.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></IconBase>;
        const HelpCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></IconBase>;
        const History = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconBase>;
        const ExternalLink = (props) => <IconBase {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;
        const SortAsc = (props) => <IconBase {...props}><path d="m3 8 4-4 4 4"/><path d="M7 4v16"/><path d="M11 12h10"/><path d="M11 16h7"/><path d="M11 20h4"/></IconBase>;
        const SortDesc = (props) => <IconBase {...props}><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="M11 12h10"/><path d="M11 8h7"/><path d="M11 4h4"/></IconBase>;
        const LinkIcon = (props) => <IconBase {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconBase>;
        const ChevronLeft = (props) => <IconBase {...props}><path d="m15 18-6-6 6-6"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><path d="m9 18 6-6-6-6"/></IconBase>;
        const Info = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const FilterIcon = (props) => <IconBase {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></IconBase>;

        // --- 2. Data ---
        const FALLBACK_STOCKS = [
          {
            id: '2330', name: 'å°ç©é›»', price: 1680, low: 1675, change: -2.0, volume: 31237, avgVolume5dVal: 480, priceAvg20d: 1700, priceAvg60d: 1720, bollingerLower: 1650, marketCapVal: 435700, rsi6: 35, netBuy5d: -5000, institutionalHoldings: 78, eps4Q: 61.2, roe: 28.5, isExDividend: false, sector: 'åŠå°é«”', panicLevel: 35, fairValue: 1900, resistancePrice: 1750, 
            history: [{ date: '01/06', price: 1705 }, { date: '01/07', price: 1695 }, { date: '01/08', price: 1700 }, { date: '01/09', price: 1680 }, { date: '01/10', price: 1685 }, { date: '01/12', price: 1680 }],
            aiDiagnosis: { probability: 65, natureTag: 'EXTERNAL', conclusion: 'å—åœ‹éš›å±€å‹¢å½±éŸ¿å°è‡´å¤–è³‡é¿éšªè³£å‡ºï¼Œé€™ä¸¦éå…¬å¸ç‡Ÿé‹å‡ºå•é¡Œï¼Œè€Œæ˜¯å¤–éƒ¨å› ç´ é€ æˆçš„éç†æ€§ä¸‹è·Œã€‚', reasons: ['å¤–è³‡é¿éšªè³£å£“ï¼šå› æ‡‰ä¸­æ±åœ°ç·£å±€å‹¢å‡æº«ï¼Œå¤–è³‡å–®æ—¥ææ¬¾ 1.5 è¬å¼µã€‚', 'è²»åŠé€£å‹•ï¼šç¾è‚¡ SOX æŒ‡æ•¸é‡æŒ« 4.2%ï¼Œæ‹–ç´¯åŠå°é«”æ¬Šå€¼è‚¡ã€‚', 'éŒ¯æ®ºæ€§è³ªï¼šå…ˆé€²è£½ç¨‹ç”¢èƒ½æ»¿è¼‰ï¼ŒåŸºæœ¬é¢æœªè®Šï¼Œç´”å±¬è³‡é‡‘é¢ææ¬¾ã€‚'], recoveryDays: '15 ~ 20', volumeStatus: 'é‡ç¸®æ•´ç†', potentialUpside: 13, strategy: 'å»ºè­°è§€æœ›ï¼Œå¾…ç«™å›äº”æ—¥ç·šå¾Œåˆ†æ‰¹ä½ˆå±€ã€‚' },
            similarHistory: [{ date: '2022.02', event: 'ä¿„çƒæˆ°çˆ­çˆ†ç™¼', outcome: 'è‚¡åƒ¹æ€¥è·Œ 15% å¾Œï¼Œæ–¼ 2 å€‹æœˆå…§æ”¶å¾©å¤±åœŸä¸¦å‰µæ–°é«˜ã€‚' }],
            newsLinks: [{ title: 'å¤–è³‡è§€é»ï¼šåœ°ç·£é¢¨éšªä¸å½±éŸ¿ 2nm é ˜å…ˆåœ°ä½', source: 'è²¡ç¶“æ—¥å ±', url: '#' }, { title: 'å°ç©é›»æ³•èªªæœƒå‰ç»ï¼šå…ˆé€²è£½ç¨‹éœ€æ±‚å¼·å‹', source: 'ç§‘æŠ€æ–°å ±', url: '#' }, { title: 'å…¨çƒåŠå°é«”åº«å­˜å»åŒ–é †åˆ©ï¼ŒQ1 å¯æœ›è½åº•', source: 'æŠ•è³‡äººå‘¨åˆŠ', url: '#' }]
          },
          {
            id: '2454', name: 'è¯ç™¼ç§‘', price: 1410, low: 1400, change: -3.5, volume: 4250, avgVolume5dVal: 55, priceAvg20d: 1460, priceAvg60d: 1480, bollingerLower: 1420, marketCapVal: 22700, rsi6: 25, netBuy5d: 200, institutionalHoldings: 65, eps4Q: 66.6, roe: 27.1, isExDividend: false, sector: 'ICè¨­è¨ˆ', panicLevel: 85, fairValue: 1650, resistancePrice: 1500,
            history: [{ date: '01/06', price: 1480 }, { date: '01/07', price: 1460 }, { date: '01/08', price: 1450 }, { date: '01/09', price: 1445 }, { date: '01/10', price: 1430 }, { date: '01/12', price: 1410 }],
            aiDiagnosis: { probability: 85, natureTag: 'SHORT_TERM', conclusion: 'ç”¢å“åƒ…æ˜¯å»¶å¾Œå‡ºè²¨è€Œéè¨‚å–®æ¶ˆå¤±ï¼Œé›–ç„¶å¸‚å ´å› èª¤è§£è€Œæ‹‹å”®ï¼Œä½†å¤§æˆ¶è³‡é‡‘å·²é–‹å§‹é€¢ä½æ‰¿æ¥ã€‚', reasons: ['å»¶å¾Œå‡ºè²¨æ•ˆæ‡‰ï¼š5G æ——è‰¦æ™¶ç‰‡å‡ºè²¨å»¶è‡³ 2æœˆï¼Œå°è‡´ 1æœˆç‡Ÿæ”¶æœˆæ¸› 12%ã€‚', 'è¬ è¨€æ¾„æ¸…ï¼šå¸‚å ´å‚³èé™¸ç³»æ‰‹æ©Ÿç å–®ï¼Œå…¬å¸å·²ç™¼é‡è¨Šåš´æ­£å¦èªã€‚', 'ç±Œç¢¼ç•°å¸¸ï¼šè‚¡åƒ¹ç ´åº•ä½†ä¸»åŠ›åˆ¸å•†ï¼ˆç¾æ—ã€æ‘©æ ¹ï¼‰é€†å‹¢è²·è¶… 800 å¼µã€‚'], recoveryDays: '10 ~ 15', volumeStatus: 'çª’æ¯é‡', potentialUpside: 17, strategy: 'Strong Buyã€‚å»ºè­°åˆ† 3 æ—¥é€²å ´ï¼Œé¦–ç­†è³‡é‡‘å¯æ–¼ä»Šæ—¥å°¾ç›¤æŠ•å…¥ã€‚' },
            similarHistory: [{ date: '2021.05', event: 'ä¾›æ‡‰éˆç¼ºæ–™ç–‘æ…®', outcome: 'æ¾„æ¸…å¾Œè‚¡åƒ¹é€£ä¸‰ç´…ï¼Œå–®å‘¨åå½ˆ 8%ã€‚' }],
            newsLinks: [{ title: 'è¯ç™¼ç§‘å¤©ç’£ 9500 å¯¦æ¸¬æ•¸æ“šæ›å…‰ï¼Œæ•ˆèƒ½è¶…é æœŸ', source: '3C ç§‘æŠ€ç¶²', url: '#' }, { title: 'å¤§æ‘©é‡ç”³è¯ç™¼ç§‘ã€Œå„ªæ–¼å¤§ç›¤ã€è©•ç­‰ï¼Œç›®æ¨™åƒ¹ä¸è®Š', source: 'å¤–è³‡è§€æ¸¬ç«™', url: '#' }, { title: 'ä¸­åœ‹æ‰‹æ©Ÿå¸‚å ´å¾©ç”¦ï¼Œæ——è‰¦æ™¶ç‰‡éœ€æ±‚çœ‹å¢', source: 'ç”¢æ¥­å¿«è¨Š', url: '#' }]
          },
          {
            id: '3037', name: 'æ¬£èˆˆ', price: 175.0, low: 172.0, change: -4.5, volume: 12000, avgVolume5dVal: 20, priceAvg20d: 185.0, priceAvg60d: 195.0, bollingerLower: 178.0, marketCapVal: 2700, rsi6: 18, netBuy5d: -1500, institutionalHoldings: 40, eps4Q: 8.5, roe: 15.2, isExDividend: false, sector: 'PCB', panicLevel: 85, fairValue: 220, resistancePrice: 190,
            history: [{ date: '01/06', price: 195 }, { date: '01/07', price: 190 }, { date: '01/08', price: 188 }, { date: '01/09', price: 185 }, { date: '01/10', price: 182 }, { date: '01/12', price: 175 }],
            aiDiagnosis: { probability: 70, natureTag: 'EXTERNAL', conclusion: 'å—åˆ°åŒæ¥­è² é¢æ¶ˆæ¯æ‹–ç´¯ï¼Œå¼•ç™¼æŠ•è³‡äººææ…Œæ€§è³£å‡ºï¼Œå°è‡´ç›®å‰ç±Œç¢¼ç‹€æ…‹ä»è™•æ–¼ä¸ç©©å®šéšæ®µã€‚', reasons: ['å ±åƒ¹é¬†å‹•ç–‘æ…®ï¼šæ—¥å•† Ibiden è²¡å ±ç¤ºè­¦ ABF éœ€æ±‚æ”¾ç·©ï¼Œå¼•ç™¼æ—ç¾¤ä¿®æ­£ã€‚', 'ææ…Œæ€§è³£å‡ºï¼šèè³‡ç¶­æŒç‡è·Œç ´ 140% è­¦æˆ’ç·šï¼Œè§¸ç™¼æ•£æˆ¶å¤šæ®ºå¤šã€‚', 'æŠ•ä¿¡åœæï¼šæŠ•ä¿¡å­£åº•çµå¸³è³£å£“æ¹§ç¾ï¼Œé€£çºŒ 5 æ—¥è³£è¶…åˆè¨ˆ 6,200 å¼µã€‚'], recoveryDays: '20 ~ 25', volumeStatus: 'çˆ†é‡ä¸‹æ®º', potentialUpside: 25, strategy: 'æ€¥è·Œä¸æ¥åˆ€ã€‚å¾…æˆäº¤é‡ç¸®è‡³ 5000 å¼µä»¥ä¸‹å†è¡Œä»‹å…¥ã€‚' },
            similarHistory: [{ date: '2023.04', event: 'åº«å­˜å»åŒ–ä¿®æ­£', outcome: 'è‚¡åƒ¹ç›¤æ•´ 3 å€‹æœˆå¾Œæ‰ç¯‰åº•å®Œæˆï¼Œå±¬Lå‹å¾©ç”¦ã€‚' }],
            newsLinks: [{ title: 'ABF è¼‰æ¿å ±åƒ¹é¬†å‹•ï¼Ÿæ¥­å…§äººå£«ï¼šåƒ…éƒ¨åˆ†ä½éšç”¢å“', source: 'é›»å­æ™‚å ±', url: '#' }, { title: 'æŠ•ä¿¡å­£åº•çµå¸³åå–®å‡ºåˆ—ï¼ŒPCB æ—ç¾¤é¦–ç•¶å…¶è¡', source: 'ç†è²¡ç¶²', url: '#' }, { title: 'Ibiden è²¡å ±ä¸å¦‚é æœŸï¼Œæ‹–ç´¯äºæ´²è¼‰æ¿è‚¡', source: 'åœ‹éš›è²¡ç¶“', url: '#' }]
          },
          {
            id: '8298', name: 'åœ°é›·KY', price: 32.0, change: -9.8, volume: 500, avgVolume5dVal: 0.08, priceAvg20d: 40, priceAvg60d: 45, bollingerLower: 30, marketCapVal: 50, rsi6: 10, netBuy5d: -50, institutionalHoldings: 2, eps4Q: -2.5, roe: -10, isExDividend: false, sector: 'ç”ŸæŠ€', panicLevel: 95, fairValue: 20, resistancePrice: 35,
            history: Array(6).fill({date: '01/12', price: 32}),
            aiDiagnosis: { probability: 10, natureTag: 'STRUCTURAL', conclusion: 'ç”±æ–¼å¸³ç›®å•é¡Œå°šå¾…é‡æ¸…ï¼Œå…¬å¸è²¡å‹™çµæ§‹å­˜åœ¨é«˜åº¦ä¸ç¢ºå®šæ€§ï¼Œé€™å±¬æ–¼ä¼æ¥­æœ¬è³ªä¸Šçš„é¢¨éšªã€‚', reasons: ['æœƒè¨ˆå¸«ä¿ç•™æ„è¦‹ï¼šç„¡æ³•é‡æ¸…æµ·å¤–å­å…¬å¸ 5 å„„å…ƒå¸³æ¬¾æµå‘ï¼Œè²¡å ±å¡é—œã€‚', 'å¤§è‚¡æ±æ‹‹å”®ï¼šè‘£äº‹é•·é…å¶ç”³å ±è½‰è®“æŒè‚¡ 2,000 å¼µï¼Œå¼•ç™¼æç©ºç–‘æ…®ã€‚', 'æœ¬è³ªé¢¨éšªï¼šä¸»è¦æ­ç¾å®¢æˆ¶çµ‚æ­¢åˆç´„ï¼Œç‡Ÿæ”¶é¢è‡¨è…°æ–¬é¢¨éšªã€‚'], recoveryDays: 'N/A', volumeStatus: 'ç„¡é‡è·Œåœ', potentialUpside: 0, strategy: 'è³£å‡ºã€‚ä¸æ¶åå½ˆã€‚' },
            similarHistory: [],
            newsLinks: [{ title: 'åœ°é›·KY é‡è¨Šè¨˜è€…æœƒï¼šç„¡æ³•è§£é‡‹è³‡é‡‘æµå‘', source: 'è­‰äº¤æ‰€', url: '#' }, { title: 'é‡‘ç®¡æœƒä»‹å…¥èª¿æŸ¥ï¼Œåœ°é›·KY æé¢è‡¨æš«åœäº¤æ˜“', source: 'æ–°èé ­æ¢', url: '#' }, { title: 'å°è‚¡æ±è‡ªæ•‘æœƒæˆç«‹ï¼Œæ“¬å°ç¶“ç‡Ÿå±¤æå‘Š', source: 'ç¤¾æœƒæ–°è', url: '#' }]
          }
        ];

        const apiService = {
            fetchMarketData: async () => {
                const targetIDs = ['2330', '2454', '3037']; 
                const now = new Date();
                const past = new Date(now);
                past.setDate(now.getDate() - 60); 
                const startDate = past.toISOString().split('T')[0];
                
                try {
                    const requests = targetIDs.map(id => 
                        fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${id}&start_date=${startDate}`)
                            .then(res => res.json())
                    );
                    
                    const results = await Promise.all(requests);
                    
                    return FALLBACK_STOCKS.map(stock => {
                        const res = results.find(r => r.data && r.data.length > 0 && r.data[0].stock_id === stock.id);
                        if (!res) return stock; 
                        
                        const dataPoints = res.data;
                        const latest = dataPoints[dataPoints.length - 1]; 
                        const prev = dataPoints.length > 1 ? dataPoints[dataPoints.length - 2] : null; 
                        
                        const price = latest.close;
                        const change = prev ? ((price - prev.close) / prev.close * 100) : 0;
                        
                        const history = dataPoints.slice(-10).map(d => ({
                            date: d.date.slice(5).replace('-', '/'),
                            price: d.close
                        }));

                        return {
                            ...stock,
                            price: price,
                            change: parseFloat(change.toFixed(2)),
                            volume: Math.round(latest.Trading_Volume / 1000),
                            history: history.length > 0 ? history : stock.history
                        };
                    });

                } catch (e) {
                    console.error("FinMind API Error:", e);
                    return new Promise(r => setTimeout(() => r(FALLBACK_STOCKS), 800));
                }
            }
        };

        // --- 3. Logic Functions ---
        const analyzeStock = (stock) => {
          const analysis = { checks: [], triggerTypes: [], isPassed: true, failReason: null, opportunityScore: 0, deviation: 0 };
          const isLiquid = stock.avgVolume5dVal >= 0.1;
          const isProfitable = stock.eps4Q > 0;
          
          analysis.checks.push({ name: 'æµå‹•æ€§ > 1000è¬', pass: isLiquid, value: 'Pass' });
          analysis.checks.push({ name: 'ç²åˆ©å®‰å…¨ (EPS > 0)', pass: isProfitable, value: stock.eps4Q });
          
          if (stock.rsi6 < 30) analysis.triggerTypes.push('RSI_OVERSOLD');
          if (stock.price < stock.bollingerLower) analysis.triggerTypes.push('BB_BREAK');

          if (analysis.isPassed) {
              const probScore = stock.aiDiagnosis.probability;
              analysis.deviation = ((stock.price - stock.priceAvg60d) / stock.priceAvg60d) * 100;
              const deviationScore = Math.min(Math.abs(analysis.deviation) * 3.5, 100);
              let chipScore = stock.netBuy5d > 0 ? 100 : (stock.institutionalHoldings > 50 ? 50 : 0);
              analysis.opportunityScore = Math.round((probScore * 0.5) + (deviationScore * 0.3) + (chipScore * 0.2));
          }
          return analysis;
        };

        // --- 4. Sub-Components (Defined as const for strict ordering) ---
        const NatureBadge = ({ tag }) => {
          if (tag === 'SHORT_TERM') return <span className="px-2 py-0.5 bg-green-100 text-green-800 rounded text-sm font-bold border border-green-200 inline-flex items-center gap-1 whitespace-nowrap">ğŸŸ¢ çŸ­æœŸæ„å¤–</span>;
          if (tag === 'EXTERNAL') return <span className="px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded text-sm font-bold border border-yellow-200 inline-flex items-center gap-1 whitespace-nowrap">ğŸŸ¡ å¤–éƒ¨ç’°å¢ƒ</span>;
          if (tag === 'STRUCTURAL') return <span className="px-2 py-0.5 bg-red-100 text-red-800 rounded text-sm font-bold border border-red-200 inline-flex items-center gap-1 whitespace-nowrap">ğŸ”´ çµæ§‹æå£</span>;
          return null;
        };

        const Modal = ({ isOpen, onClose, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto animate-in zoom-in-95 duration-200">
                        <button onClick={onClose} className="absolute top-4 right-4 p-1 text-slate-400 hover:text-slate-600 rounded-full hover:bg-slate-100 transition-colors">
                            <X size={20} />
                        </button>
                        <div className="p-6">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // This component content is now inside the modal
        const GuideContent = () => (
          <div className="text-sm">
            <h3 className="font-bold text-slate-800 text-lg mb-4 flex items-center gap-2">
              <Lightbulb size={20} className="text-yellow-500"/> ç¯©é¸é‚è¼¯èˆ‡æ¨™ç±¤èªªæ˜
            </h3>
            <div className="space-y-6">
              <div>
                <h4 className="font-bold text-slate-500 text-xs uppercase mb-3 flex items-center gap-1 pb-1 border-b border-slate-100"><FilterIcon size={14} /> åš´é¸æ¨™æº–</h4>
                <ul className="space-y-3 text-slate-600 text-sm">
                  <li className="flex items-start gap-2"><span className="text-indigo-500 font-bold mt-0.5">â€¢</span> <span><b>æµå‹•æ€§</b>ï¼šè¿‘äº”æ—¥å‡é‡ &gt; 1000 è¬ï¼Œç¢ºä¿é€²å‡ºå®¹æ˜“ã€‚</span></li>
                  <li className="flex items-start gap-2"><span className="text-indigo-500 font-bold mt-0.5">â€¢</span> <span><b>åŸºæœ¬é¢</b>ï¼šè¿‘å››å­£ EPS &gt; 0ï¼Œåªé¸æœ‰è³ºéŒ¢çš„å…¬å¸ã€‚</span></li>
                  <li className="flex items-start gap-2"><span className="text-indigo-500 font-bold mt-0.5">â€¢</span> <span><b>æŠ€è¡“é¢</b>ï¼šRSI &lt; 30 æˆ– è‚¡åƒ¹è·Œç ´å¸ƒæ—é€šé“ä¸‹è»Œï¼Œå°‹æ‰¾è¶…è·Œè¨Šè™Ÿã€‚</span></li>
                </ul>
              </div>
              <div>
                <h4 className="font-bold text-slate-500 text-xs uppercase mb-3 flex items-center gap-1 pb-1 border-b border-slate-100"><Info size={14} /> æ€§è³ªæ¨™ç±¤å®šç¾©</h4>
                <div className="space-y-3">
                  <div className="flex items-start gap-3">
                    <span className="px-2 py-0.5 bg-green-100 text-green-800 rounded text-xs font-bold border border-green-200 shrink-0 mt-0.5">ğŸŸ¢ çŸ­æœŸæ„å¤–</span>
                    <span className="text-sm text-slate-600 leading-snug">éŒ¯æ®ºï¼ŒåŸºæœ¬é¢ç„¡è™ã€‚é€šå¸¸æ˜¯å—çŸ­æœŸæ¶ˆæ¯å½±éŸ¿ï¼Œå›å½ˆé€Ÿåº¦æœ€å¿«ã€‚</span>
                  </div>
                  <div className="flex items-start gap-3">
                    <span className="px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded text-xs font-bold border border-yellow-200 shrink-0 mt-0.5">ğŸŸ¡ å¤–éƒ¨ç’°å¢ƒ</span>
                    <span className="text-sm text-slate-600 leading-snug">å—å¤§ç›¤ä¿®æ­£æˆ–ç”¢æ¥­å¾ªç’°æ‹–ç´¯ã€‚éœ€è¦ç­‰å¾…å¸‚å ´æ°£æ°›å¥½è½‰ã€‚</span>
                  </div>
                  <div className="flex items-start gap-3">
                    <span className="px-2 py-0.5 bg-red-100 text-red-800 rounded text-xs font-bold border border-red-200 shrink-0 mt-0.5">ğŸ”´ çµæ§‹æå£</span>
                    <span className="text-sm text-slate-600 leading-snug">è²¡å‹™æˆ–ç‡Ÿé‹æœ‰é‡å¤§ç–‘æ…®ã€‚é¢¨éšªæ¥µé«˜ï¼Œå»ºè­°é¿é–‹ã€‚</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );

        const StockCard = ({ stock, analysis, onClick }) => {
          const isPassed = analysis.isPassed;
          return (
            <div onClick={() => onClick(stock)} className={`relative bg-white p-3 rounded-xl border transition-all cursor-pointer hover:shadow-md active:scale-[0.98] ${!isPassed ? 'opacity-60 grayscale-[0.5] border-slate-200' : 'border-slate-100 hover:border-indigo-200 shadow-sm'}`}>
              {!isPassed && <div className="absolute top-2 right-2 px-2 py-0.5 bg-slate-100 text-slate-500 text-sm font-bold rounded flex items-center gap-1"><XCircle size={12} /> {analysis.failReason || "æœªå…¥é¸"}</div>}
              <div className="flex justify-between items-start mb-3">
                <div className="flex items-center gap-3">
                  <div className={`w-12 h-12 rounded-lg flex items-center justify-center font-bold text-white text-sm ${isPassed ? 'bg-indigo-600' : 'bg-slate-400'}`}>{stock.id}</div>
                  <div><h3 className="font-bold text-slate-800 text-lg leading-tight group-hover:text-indigo-600 transition-colors">{stock.name}</h3></div>
                </div>
                <div className="text-right">
                  <div className="font-mono text-xl font-bold text-slate-900">{stock.price.toFixed(2)}</div>
                  <div className={`font-mono text-sm font-bold ${stock.change < 0 ? 'text-green-600' : 'text-red-600'}`}>{stock.change}%</div>
                </div>
              </div>
              {isPassed && (
                <div className="mb-3 flex items-start gap-2">
                    <div className="shrink-0 mt-0.5"><NatureBadge tag={stock.aiDiagnosis.natureTag} /></div>
                    <div className="text-sm text-slate-600 leading-relaxed line-clamp-2">{stock.aiDiagnosis.conclusion}</div>
                </div>
              )}
              <div className="flex items-center gap-3 pt-2 border-t border-slate-50 overflow-x-auto scrollbar-hide">
                {isPassed ? (
                  <React.Fragment>
                      <div className="flex items-center gap-1.5 whitespace-nowrap shrink-0">
                        <span className="text-sm text-slate-400 uppercase tracking-wide">ç²åˆ©ç©ºé–“</span>
                        <span className="text-sm font-bold text-green-600">+{stock.aiDiagnosis.potentialUpside}%</span>
                      </div>
                      <div className="w-px h-3 bg-slate-200 shrink-0"></div>
                      <div className="flex items-center gap-1.5 whitespace-nowrap shrink-0">
                        <span className="text-sm text-slate-400 uppercase tracking-wide">å›å¾©æ™‚é–“</span>
                        <span className="text-sm font-bold text-slate-700">{stock.aiDiagnosis.recoveryDays}å¤©</span>
                      </div>
                  </React.Fragment>
                ) : (<div className="text-sm text-slate-400">ç­‰å¾…è§¸ç™¼ä¿¡è™Ÿ...</div>)}
              </div>
            </div>
          );
        };

        const DetailView = ({ stock, analysis, onBack, onPrev, onNext, hasPrev, hasNext }) => {
          const { aiDiagnosis } = stock;
          const resistancePercent = useMemo(() => {
            const totalRange = stock.fairValue - stock.price;
            const resistanceOffset = stock.resistancePrice - stock.price;
            if (totalRange <= 0) return 0;
            return Math.max(10, Math.min(90, (resistanceOffset / totalRange) * 100));
          }, [stock]);

          const hasHistory = stock.similarHistory && stock.similarHistory.length > 0;

          return (
            <div className="animate-in slide-in-from-right duration-300 pb-20">
              <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center gap-2 text-slate-500 cursor-pointer hover:text-slate-800 transition-colors" onClick={onBack}>
                      <ArrowLeft size={20} /><span>è¿”å›æ¸…å–®</span>
                  </div>
                  <div className="flex items-center gap-2">
                      <button onClick={onPrev} disabled={!hasPrev} className={`p-2 rounded-full border transition-all ${hasPrev ? 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 shadow-sm' : 'bg-slate-50 border-slate-100 text-slate-300 cursor-not-allowed'}`}><ChevronLeft size={20} /></button>
                      <button onClick={onNext} disabled={!hasNext} className={`p-2 rounded-full border transition-all ${hasNext ? 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 shadow-sm' : 'bg-slate-50 border-slate-100 text-slate-300 cursor-not-allowed'}`}><ChevronRight size={20} /></button>
                  </div>
              </div>

              <div className="flex justify-between items-start mb-6">
                <div>
                  <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-2">{stock.name} <span className="text-xl text-slate-400 font-medium">{stock.id}</span></h1>
                  <p className="text-slate-500 text-sm mt-1">{stock.sector} | å¸‚å€¼ {stock.marketCapVal} å„„</p>
                </div>
                <div className="text-right">
                  <div className="text-4xl font-bold font-mono tracking-tighter">{stock.price.toFixed(2)}</div>
                  <div className="text-green-600 font-bold font-mono text-xl">{stock.change}% â–¼</div>
                </div>
              </div>

              {/* Summary Block - Tag on Left */}
              <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5 mb-6">
                  <div className="flex flex-col gap-4">
                      <div className="flex items-start gap-3">
                          <div className="shrink-0"><NatureBadge tag={aiDiagnosis.natureTag} /></div>
                          <p className="text-slate-700 leading-relaxed font-medium text-sm">{aiDiagnosis.conclusion}</p>
                      </div>
                      <div className="bg-indigo-50 rounded-lg p-4 border border-indigo-100 mt-2">
                           <h4 className="font-bold text-indigo-900 flex items-center gap-2 mb-1 text-sm"><Lightbulb size={16} /> æ“ä½œç­–ç•¥å»ºè­°</h4>
                           <p className="text-indigo-800 text-sm font-medium">{aiDiagnosis.strategy}</p>
                      </div>
                  </div>
              </div>

              {/* Data Grid: Left = Metrics, Right = Reasons */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                  {/* Left Col: Stacked Metrics */}
                  <div className="flex flex-col gap-4 lg:col-span-1">
                      <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col justify-center flex-1 relative group/tooltip-container">
                           <div className="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2 mb-2 w-fit relative group/info cursor-help">
                             <Target size={16} /> ç²åˆ©ç©ºé–“ <Info size={14} className="text-slate-400" />
                             <div className="tooltip-content absolute bottom-full mb-2 w-64 p-3 bg-slate-800 text-white text-xs rounded-lg shadow-xl pointer-events-none z-50 text-left">
                                 <div className="space-y-2">
                                     <p className="leading-relaxed text-slate-200"><span className="font-bold text-yellow-400">ç²åˆ©ç©ºé–“ï¼š</span>é æœŸçš„åˆ©æ½¤æ½›åŠ›</p>
                                     <p className="leading-relaxed text-slate-200"><span className="font-bold text-yellow-400">å£“åŠ›ä½ï¼š</span>å°±åƒæ˜¯æ¼²å‹¢çš„ã€Œæ¸›é€Ÿå¸¶ã€ï¼Œè‚¡åƒ¹åˆ°äº†é€™è£¡å®¹æ˜“æ’åˆ°å¤©èŠ±æ¿è€Œå›æª”</p>
                                 </div>
                                 <div className="absolute top-full left-4 -mt-1 border-4 border-transparent border-t-slate-800"></div>
                             </div>
                           </div>
                           <div className="py-2"> 
                               <div className="mb-2 flex items-baseline gap-2"><span className="text-4xl font-black text-green-600 tracking-tighter">+{aiDiagnosis.potentialUpside}%</span></div>
                               <div className="relative pt-6 pb-2"> 
                                   <div className="w-full h-3 bg-slate-100 rounded-full relative overflow-hidden">
                                      <div className="absolute left-0 top-0 h-full w-full bg-gradient-to-r from-green-400 to-green-600 opacity-30"></div>
                                   </div>
                                   <div className="absolute top-0 h-full flex flex-col items-center z-10" style={{ left: `${resistancePercent}%`, transform: 'translateX(-50%)' }}>
                                      <div className="mb-1"><span className="text-[10px] font-bold text-red-500 bg-red-50 px-1.5 py-0.5 rounded border border-red-100 whitespace-nowrap">å£“åŠ›ä½ ${stock.resistancePrice.toFixed(2)}</span></div>
                                      <div className="w-0.5 h-full bg-red-400 dashed relative"><div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-red-500 rounded-full border-2 border-white shadow-sm"></div></div>
                                   </div>
                               </div>
                               <div className="flex justify-between text-sm text-slate-400 mt-2"><span>ç¾åƒ¹ ${stock.price.toFixed(2)}</span><span>ç›®æ¨™ ${stock.fairValue.toFixed(2)}</span></div>
                           </div>
                      </div>

                      <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col flex-1">
                           <div className="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2 mb-3 w-fit relative group/info cursor-help">
                                <Calendar size={16} /> å›å¾©æ™‚é–“ <Info size={14} className="text-slate-400" />
                                <div className="tooltip-content absolute bottom-full mb-2 w-72 p-4 bg-slate-800 text-white text-xs rounded-lg shadow-xl pointer-events-none z-50 text-left -left-2 sm:left-0">
                                    <div className="flex items-center gap-1 font-bold text-indigo-300 mb-2"><Lightbulb size={12} /> å›å¾©æ™‚é–“è¨ˆç®—æ–¹å¼</div>
                                    <p className="leading-relaxed text-slate-200 mb-2">æˆ‘å€‘æœƒå»ç¿»ã€Œæ­·å²èˆŠå¸³ã€ï¼Œçœ‹çœ‹ä»¥å‰ç™¼ç”Ÿé¡ä¼¼äº‹ä»¶æ™‚ï¼Œè‚¡åƒ¹èŠ±äº†å¹¾å¤©æ¼²å›ä¾†ã€‚</p>
                                    <p className="leading-relaxed text-slate-200">å¦‚æœæ²’ç™¼ç”Ÿéï¼Œå°±æœƒç”¨çµ±è¨ˆå­¸ç®—å‡ºé€™é¡ã€Œè·Œéé ­ã€çš„æƒ…æ³ï¼Œé€šå¸¸éœ€è¦å¤šä¹…å›æ­¸æ­£å¸¸ã€‚</p>
                                    <div className="absolute top-full left-8 -mt-1 border-4 border-transparent border-t-slate-800"></div>
                                </div>
                           </div>
                           <div className="flex items-baseline gap-2">
                               <span className="text-4xl font-black text-slate-800 tracking-tighter">{isNaN(parseInt(aiDiagnosis.recoveryDays)) ? 'N/A' : parseInt(aiDiagnosis.recoveryDays)}</span>
                               <span className="text-sm font-bold text-slate-500">äº¤æ˜“æ—¥</span>
                           </div>
                           
                           {/* Conditional Subtext */}
                           {!hasHistory && (
                             <p className="text-xs text-slate-400 mb-4">
                               åŸºæ–¼æŠ€è¡“æŒ‡æ¨™ä¹–é›¢ç‡èˆ‡é‡èƒ½æ¨ç®—
                             </p>
                           )}

                           {/* Conditional Content: History vs Technical Basis */}
                           <div className="mt-auto pt-4 border-t border-slate-100">
                               {hasHistory ? (
                                   <>
                                           <h4 className="text-xs font-bold text-slate-500 mb-2">
                                               ç›¸ä¼¼äº‹ä»¶
                                           </h4>
                                           <div className="space-y-2">
                                               {stock.similarHistory.map((item, idx) => (
                                                   <div key={idx} className="bg-slate-100 p-3 rounded-lg">
                                                       <div className="flex justify-between items-baseline mb-1">
                                                           <div className="font-bold text-xs text-slate-800">{item.event}</div>
                                                           <span className="text-xs text-slate-500 font-mono shrink-0 ml-2">{item.date}</span>
                                                       </div>
                                                       <div className="text-xs text-slate-600 leading-relaxed">{item.outcome}</div>
                                                   </div>
                                               ))}
                                           </div>
                                   </>
                               ) : (
                                   <>
                                           <h4 className="text-xs font-bold text-slate-500 flex items-center gap-1 mb-2">
                                               <Activity size={12} /> ä¼°ç®—ä¾æ“šï¼šæŠ€è¡“ä¹–é›¢æ¨¡å‹
                                           </h4>
                                           <div className="space-y-2">
                                               <div className="bg-slate-50 p-2.5 rounded-lg border border-slate-100">
                                                   <div className="flex justify-between items-center mb-1">
                                                       <span className="text-xs text-slate-500">å­£ç·šä¹–é›¢ç‡ (Bias)</span>
                                                       <span className={`text-xs font-bold font-mono ${analysis.deviation < -10 ? 'text-green-600' : 'text-slate-700'}`}>
                                                           {analysis.deviation ? analysis.deviation.toFixed(2) : '0.00'}%
                                                       </span>
                                                   </div>
                                                   <div className="flex justify-between items-center">
                                                       <span className="text-xs text-slate-500">RSI (6) å¼·åº¦</span>
                                                       <span className={`text-xs font-bold font-mono ${stock.rsi6 < 20 ? 'text-red-500' : 'text-slate-700'}`}>
                                                           {stock.rsi6}
                                                       </span>
                                                   </div>
                                               </div>
                                               <div className="flex gap-2 items-start">
                                                    <div className="mt-0.5 w-1 h-1 rounded-full bg-slate-300 shrink-0"></div>
                                                    <p className="text-[10px] text-slate-400 leading-snug">
                                                        å› ç„¡é«˜åº¦ç›¸ä¼¼çš„æ­·å²äº‹ä»¶ï¼Œç³»çµ±æ”¹ä»¥ã€Œå‡å€¼å›æ­¸æ¨™æº–å·®ã€æ¨¡å‹ä¼°ç®—ä¿®å¾©æ™‚é–“ã€‚
                                                    </p>
                                               </div>
                                           </div>
                                   </>
                               )}
                           </div>
                      </div>
                  </div>
                  
                  {/* Right Col: Core Reasons */}
                  <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col h-full lg:col-span-1">
                      <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2 mb-4"><Microscope size={16} /> æ ¸å¿ƒåŸå› </h3>
                      <ul className="space-y-3 mb-6">
                          {aiDiagnosis.reasons.map((r, i) => (
                              <li key={i} className="flex gap-2 text-sm text-slate-700">
                              <span className="text-indigo-500 font-bold mt-0.5">â€¢</span>
                              <span>{r}</span>
                              </li>
                          ))}
                      </ul>
                      {stock.newsLinks && (
                          <div className="pt-4 border-t border-slate-100 mt-auto">
                              <h4 className="text-xs font-bold text-slate-500 mb-2">
                                  æ–°èä¾†æº
                              </h4>
                              
                              <div className="bg-slate-100 rounded-xl p-3">
                                  <div className="divide-y divide-slate-200/50">
                                      {stock.newsLinks.map((link, idx) => (
                                          <a href={link.url} key={idx} target="_blank" rel="noopener noreferrer" className="block py-3 first:pt-0 last:pb-0 hover:opacity-75 transition-opacity group">
                                            <div className="font-bold text-xs text-slate-800 mb-1 leading-snug group-hover:text-indigo-700">{link.title}</div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-xs text-slate-500">{link.source}</span>
                                                <ExternalLink size={12} className="text-slate-400 group-hover:text-indigo-500" />
                                            </div>
                                          </a>
                                      ))}
                                  </div>
                              </div>
                          </div>
                      )}
                  </div>
              </div>

              <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5 mb-6">
                 <div className="flex flex-col gap-2 mb-4">
                    <div className="flex justify-between items-center"><h3 className="font-bold text-slate-800 flex items-center gap-2"><Activity size={18} /> æŠ€è¡“èµ°å‹¢</h3></div>
                    <div className="text-sm text-slate-400 mt-1 px-1"><p>ç•¶è—è‰²å¯¦ç·šï¼ˆç¾åƒ¹ï¼‰é ä½æ–¼è™›ç·šæ™‚ï¼Œä¸­é–“çš„ç©ºéš™å³ç‚ºæ½›åœ¨çš„åå½ˆç©ºé–“ã€‚</p></div>
                 </div>
                 <div className="h-64 w-full">
                   <ResponsiveContainer width="100%" height="100%">
                     <AreaChart data={stock.history}>
                       <defs><linearGradient id="colorPrice" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#4f46e5" stopOpacity={0.1}/><stop offset="95%" stopColor="#4f46e5" stopOpacity={0}/></linearGradient></defs>
                       <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                       <XAxis dataKey="date" axisLine={false} tickLine={false} tick={{fontSize: 12, fill: '#94a3b8'}} />
                       <YAxis domain={['auto', 'auto']} axisLine={false} tickLine={false} tick={{fontSize: 12, fill: '#94a3b8'}} />
                       <Tooltip formatter={(value) => value.toFixed(2)} />
                       <ReferenceLine y={stock.priceAvg20d} label={{ value: "æœˆç·š (20MA)", fill: '#3b82f6', fontSize: 11, position: 'insideTopRight' }} stroke="#3b82f6" strokeDasharray="3 3" />
                       <ReferenceLine y={stock.priceAvg60d} label={{ value: "å­£ç·š (60MA)", fill: '#ef4444', fontSize: 11, position: 'insideTopRight' }} stroke="#ef4444" strokeDasharray="3 3" />
                       <Area type="monotone" dataKey="price" stroke="#4f46e5" fillOpacity={1} fill="url(#colorPrice)" strokeWidth={2} />
                     </AreaChart>
                   </ResponsiveContainer>
                 </div>
              </div>
            </div>
          );
        };

        // --- 5. Main App (Defined last to ensure sub-components exist) ---
        const App = () => {
          const [stocks, setStocks] = useState([]);
          const [selectedStock, setSelectedStock] = useState(null);
          const [sortType, setSortType] = useState('score');
          const [isLoading, setIsLoading] = useState(true);
          const [lastUpdated, setLastUpdated] = useState('');
          const [searchQuery, setSearchQuery] = useState('');
          const [showHelp, setShowHelp] = useState(false);

          useEffect(() => {
            const fetchData = async () => {
                setIsLoading(true);
                try {
                    const data = await apiService.fetchMarketData();
                    setStocks(data);
                    const today = new Date();
                    setLastUpdated(`${today.getFullYear()}/${(today.getMonth()+1).toString().padStart(2, '0')}/${today.getDate().toString().padStart(2, '0')}`);
                } catch (error) { console.error(error); } 
                finally { setIsLoading(false); }
            };
            fetchData();
          }, []);

          const handleRefresh = async () => {
             setIsLoading(true);
             const data = await apiService.fetchMarketData();
             setStocks(data);
             setIsLoading(false);
          };

          const processedStocks = useMemo(() => {
            // 1. Filter first
            let filtered = stocks;
            if (searchQuery) {
                const q = searchQuery.toLowerCase();
                filtered = stocks.filter(s => s.id.includes(q) || s.name.toLowerCase().includes(q));
            }

            // 2. Analyze
            const analyzed = filtered.map(stock => ({ ...stock, analysis: analyzeStock(stock) }));
            
            // 3. Sort
            return analyzed.sort((a, b) => {
                if (sortType === 'recovery') {
                    const getDays = (s) => isNaN(parseInt(s.aiDiagnosis.recoveryDays)) ? 999 : parseInt(s.aiDiagnosis.recoveryDays);
                    return getDays(a) - getDays(b);
                }
                if (sortType === 'upside') return b.aiDiagnosis.potentialUpside - a.aiDiagnosis.potentialUpside;
                return b.analysis.opportunityScore - a.analysis.opportunityScore;
            });
          }, [stocks, sortType, searchQuery]);

          return (
            <div className="min-h-screen bg-slate-50 text-slate-900 font-sans pb-20">
              <Modal isOpen={showHelp} onClose={() => setShowHelp(false)}>
                  <GuideContent />
              </Modal>

              <nav className="bg-white border-b border-slate-200 sticky top-0 z-10 px-4 py-3 shadow-sm">
                <div className="max-w-5xl mx-auto flex justify-between items-center">
                  <div className="flex items-center gap-2">
                      <div className="bg-rose-500 text-white p-2 rounded-lg shadow-lg shadow-rose-200"><Activity size={20} strokeWidth={3} /></div>
                      <span className="font-bold text-xl tracking-tight text-slate-800">Rebounder</span>
                  </div>
                  <div className="flex items-center gap-3">
                    {lastUpdated && <span className="text-xs font-mono text-slate-400 hidden sm:inline">{lastUpdated} æ”¶ç›¤åƒ¹</span>}
                    <button onClick={handleRefresh} disabled={isLoading} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-colors disabled:opacity-50"><RefreshCw size={20} className={isLoading ? "animate-spin" : ""} /></button>
                  </div>
                </div>
              </nav>

              <main className="max-w-5xl mx-auto px-4 py-6">
                {selectedStock ? (
                  <DetailView 
                      stock={selectedStock} analysis={selectedStock.analysis} 
                      onBack={() => setSelectedStock(null)} 
                      onPrev={() => { const idx = processedStocks.findIndex(s => s.id === selectedStock.id); if (idx > 0) setSelectedStock(processedStocks[idx - 1]); }}
                      onNext={() => { const idx = processedStocks.findIndex(s => s.id === selectedStock.id); if (idx < processedStocks.length - 1) setSelectedStock(processedStocks[idx + 1]); }}
                      hasPrev={processedStocks.findIndex(s => s.id === selectedStock.id) > 0}
                      hasNext={processedStocks.findIndex(s => s.id === selectedStock.id) < processedStocks.length - 1}
                  />
                ) : (
                  <div className="animate-in fade-in duration-300">
                    <div className="bg-white p-3 rounded-xl shadow-sm border border-slate-200 mb-6 overflow-x-auto">
                        <div className="mb-4 relative">
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <Search className="h-5 w-5 text-slate-400" />
                            </div>
                            <input
                                type="text"
                                className="block w-full pl-10 pr-3 py-2.5 border border-slate-200 rounded-lg leading-5 bg-slate-50 placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 sm:text-sm shadow-sm transition-all"
                                placeholder="æœå°‹ä»£è™Ÿæˆ–åç¨± (ä¾‹å¦‚: 2330)"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                            />
                        </div>
                        <div className="flex items-center justify-between pt-2 border-t border-slate-100">
                            <div className="flex items-center gap-2 whitespace-nowrap overflow-x-auto scrollbar-hide">
                                <span className="text-xs font-bold text-slate-400 uppercase tracking-wider mr-1">æ’åº:</span>
                                <button onClick={() => setSortType('score')} className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all ${sortType === 'score' ? 'bg-slate-900 text-white shadow-md' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'}`}>æ™ºæ…§æ¨è–¦</button>
                                <button onClick={() => setSortType('recovery')} className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all ${sortType === 'recovery' ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'}`}>å›å¾©æ™‚é–“ï¼šæœ€çŸ­</button>
                                <button onClick={() => setSortType('upside')} className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all ${sortType === 'upside' ? 'bg-green-600 text-white shadow-md' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'}`}>ç²åˆ©ç©ºé–“ï¼šæœ€å¤§</button>
                            </div>
                            <button onClick={() => setShowHelp(true)} className="flex items-center gap-1 px-2 py-1.5 text-slate-400 hover:text-indigo-600 hover:bg-slate-50 rounded-lg transition-colors shrink-0 ml-2" title="èªªæ˜">
                                <HelpCircle size={14} />
                                <span className="text-xs font-bold">è‚¡ç¥¨ç¯©é¸èªªæ˜</span>
                            </button>
                        </div>
                    </div>

                    {/* Original GuideCard removed from here as per request to move it to popup */}

                    <div className="space-y-4">
                      {isLoading ? (
                        <div className="flex flex-col items-center justify-center py-20 space-y-4"><div className="spinner"></div><p className="text-slate-400 text-sm animate-pulse">æ­£åœ¨ç‚ºæ‚¨è¨ºæ–·å¸‚å ´æ•¸æ“š...</p></div>
                      ) : (
                        processedStocks.length > 0 ? processedStocks.map(stock => <StockCard key={stock.id} stock={stock} analysis={stock.analysis} onClick={setSelectedStock} />) : 
                        <div className="text-center py-20 bg-white rounded-xl border border-dashed border-slate-300">
                            <div className="bg-slate-50 p-4 rounded-full inline-block mb-3">
                                {searchQuery ? <Search size={32} className="text-slate-400" /> : <CheckCircle size={32} className="text-green-500" />}
                            </div>
                            <p className="text-slate-900 font-bold text-lg">{searchQuery ? 'æ‰¾ä¸åˆ°ç¬¦åˆçš„å€‹è‚¡' : 'ç›®å‰å¸‚å ´ç„¡è¶…è·Œæ¨™çš„'}</p>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </main>
            </div>
          );
        };

        // --- 6. Render ---
        setTimeout(() => {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                const root = ReactDOM.createRoot(rootElement);
                root.render(<App />);
            }
        }, 100);
    </script>
</body>
</html>
